<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Organiseur d‚Äô√©quipe ‚Äì Rematch (Tout-en-un + menu + balle)</title>
  <style>
    :root {
      --bg:#111418; --text:#e7e7e7; --muted:#9aa4af;
      --grass-a:#1b5e20; --grass-b:#2e7d32;
      --white:rgba(255,255,255,0.9); --line:rgba(255,255,255,0.8);
      --blue:#3b82f6; --red:#ef4444;
      --ring-blue:rgba(59,130,246,0.25); --ring-red:rgba(239,68,68,0.25);
      --zones:rgba(255,255,255,0.06); --label:rgba(255,255,255,0.55);
      --card:#0f1317; --border:rgba(255,255,255,.15);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
         background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;gap:16px;padding:16px}
    .toolbar{width:100%;max-width:1100px;display:grid;grid-template-columns:1fr 1.1fr 2fr;gap:12px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);
          border-radius:16px;padding:10px 12px;display:flex;align-items:center;gap:10px}
    .select,.button{background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:10px;padding:8px 10px;font-size:14px}
    .button{background:#fff;color:#0f1317;font-weight:600;cursor:pointer;border-color:transparent}
    .button.ghost{background:var(--card);color:var(--text);border:1px solid var(--border);font-weight:500}
    .legend-dot{width:10px;height:10px;border-radius:50%;display:inline-block;vertical-align:middle;margin-right:6px}
    .dot-blue{background:var(--blue)} .dot-red{background:var(--red)}
    .field-wrap{width:100%;max-width:1100px;height:62vh;min-height:420px;border-radius:22px;overflow:hidden;position:relative;
                box-shadow:0 30px 60px rgba(0,0,0,.45);background:linear-gradient(135deg,var(--grass-a),var(--grass-b));user-select:none;touch-action:none}
    .field-stripes{position:absolute;inset:0;background-image:repeating-linear-gradient(0deg,rgba(255,255,255,.08),rgba(255,255,255,.08) 2px,transparent 2px,transparent 24px);
                   opacity:.2;pointer-events:none}
    .lines{position:absolute;inset:0;pointer-events:none}
    .border{position:absolute;inset:8px;border:4px solid var(--line);border-radius:4px}
    .midline{position:absolute;top:8px;bottom:8px;left:50%;width:2px;background:var(--line);transform:translateX(-50%)}
    .center-circle{position:absolute;left:50%;top:50%;width:160px;height:160px;border:4px solid var(--line);border-radius:50%;transform:translate(-50%,-50%)}
    .center-dot{position:absolute;left:50%;top:50%;width:6px;height:6px;background:var(--white);border-radius:50%;transform:translate(-50%,-50%)}
    .area{position:absolute;border:4px solid var(--line)}
    .goal-mark{position:absolute;width:8px;height:56px;background:var(--white);top:50%;transform:translateY(-50%)}
    .corner{position:absolute;width:24px;height:24px;border:4px solid var(--line)}
    .corner.tl{left:8px;top:8px;border-right:0;border-bottom:0;border-radius:18px 0 0 0}
    .corner.tr{right:8px;top:8px;border-left:0;border-bottom:0;border-radius:0 18px 0 0}
    .corner.bl{left:8px;bottom:8px;border-right:0;border-top:0;border-radius:0 0 0 18px}
    .corner.br{right:8px;bottom:8px;border-left:0;border-top:0;border-radius:0 0 18px 0}
    .zones{position:absolute;inset:8px;pointer-events:none;display:grid;grid-template-columns:12% 26% 24% 26% 12%}
    .zone{background:var(--zones);border-left:1px dashed rgba(255,255,255,.12);border-right:1px dashed rgba(255,255,255,.12);position:relative}
    .zone:first-child,.zone:last-child{background:transparent;border:none}
    .zone-label{position:absolute;top:8px;left:50%;transform:translateX(-50%);font-size:12px;letter-spacing:1px;color:var(--label);font-weight:700}

    .player{position:absolute;width:46px;height:46px;transform:translate(-50%,-50%);border-radius:50%;display:flex;align-items:center;justify-content:center;
            color:#fff;font-weight:700;font-size:13px;cursor:grab;box-shadow:0 12px 24px rgba(0,0,0,.35);border:4px solid transparent;touch-action:none;
            padding:0 4px;text-align:center;line-height:1.1;user-select:none}
    .player:active{cursor:grabbing} .player.blue{background:var(--blue);border-color:var(--ring-blue)} .player.red{background:var(--red);border-color:var(--ring-red)}

    /* Ball */
    .ball{position:absolute;width:36px;height:36px;transform:translate(-50%,-50%);border-radius:50%;
          display:flex;align-items:center;justify-content:center;
          font-size:22px;cursor:grab;user-select:none;filter: drop-shadow(0 8px 16px rgba(0,0,0,.35));}
    .ball:active{cursor:grabbing}

    .small{font-size:12px;color:var(--muted)}
    @media (max-width:860px){.toolbar{grid-template-columns:1fr}}

    /* Context menu */
    .ctx { position: fixed; z-index: 50; min-width: 180px; background: #11161b; color: var(--text);
           border:1px solid rgba(255,255,255,.1); border-radius:12px; box-shadow:0 18px 40px rgba(0,0,0,.4); padding:6px; display:none; }
    .ctx-btn { display:flex; align-items:center; gap:8px; width:100%; border:0; background:transparent; color:inherit; padding:10px 12px; border-radius:8px; cursor:pointer; }
    .ctx-btn:hover { background: rgba(255,255,255,.06); }
    .sep { height:1px; background: rgba(255,255,255,.08); margin:6px 0; }
  </style>
</head>
<body>
  <header class="toolbar">
    <div class="card"><strong style="font-size:16px;">Organiseur d‚Äô√©quipe ‚Äì Rematch</strong></div>
    <div class="card">
      <label for="mode" style="margin-right:8px;color:var(--muted);">Format</label>
      <select id="mode" class="select">
        <option value="3v3">3 vs 3</option>
        <option value="5v5" selected>5 vs 5</option>
      </select>
    </div>
    <div class="card" style="flex-direction:column;align-items:stretch;gap:8px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
        <div><span class="legend-dot dot-blue"></span>Bleu: <span id="blueCount">5</span></div>
        <div style="opacity:.5">‚Ä¢</div>
        <div><span class="legend-dot dot-red"></span>Rouge: <span id="redCount">5</span></div>
        <button id="reset" class="button" style="width:auto">R√©initialiser</button>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center">
        <button id="exportBtn" class="button ghost">Exporter JSON</button>
        <input id="importFile" type="file" accept="application/json" style="display:none"/>
        <button id="importBtn" class="button ghost">Importer JSON</button>
        <button id="copyShare" class="button">Copier lien de partage</button>
        <span class="small">Astuce : clic droit / appui long ‚Üí menu ‚Ä¢ Double‚Äëclic ‚Üí renommer ‚Ä¢ Lien #hash</span>
      </div>
    </div>
  </header>

  <div id="field" class="field-wrap" aria-label="Terrain de football">
    <div class="field-stripes"></div>
    <div class="lines">
      <div class="border"></div><div class="midline"></div>
      <div class="center-circle"></div><div class="center-dot"></div>
      <div class="area" style="left:8px; top:20%; height:60%; width:112px; border-left:0"></div>
      <div class="area" style="left:8px; top:30%; height:40%; width:64px; border-left:0"></div>
      <div class="goal-mark" style="left:8px"></div>
      <div class="area" style="right:8px; top:20%; height:60%; width:112px; border-right:0"></div>
      <div class="area" style="right:8px; top:30%; height:40%; width:64px; border-right:0"></div>
      <div class="goal-mark" style="right:8px"></div>
      <div class="corner tl"></div><div class="corner tr"></div><div class="corner bl"></div><div class="corner br"></div>
    </div>
    <div class="zones">
      <div class="zone"><span class="zone-label">GK</span></div>
      <div class="zone"><span class="zone-label">DEF</span></div>
      <div class="zone"><span class="zone-label">MID</span></div>
      <div class="zone"><span class="zone-label">ATT</span></div>
      <div class="zone"><span class="zone-label">GK</span></div>
    </div>
  </div>

  <!-- Context menu -->
  <div id="ctx" class="ctx" role="menu" aria-hidden="true">
    <button id="ctxRename" class="ctx-btn">‚úèÔ∏è Renommer</button>
    <button id="ctxDuplicate" class="ctx-btn">‚ûï Dupliquer</button>
    <div class="sep"></div>
    <button id="ctxDelete" class="ctx-btn">üóëÔ∏è Supprimer</button>
  </div>

  <footer class="small">
  Glisse les pions ‚Ä¢ Clic droit / appui long pour le menu ‚Ä¢ Double-clic pour renommer ‚Ä¢ Export/Import JSON ‚Ä¢ Lien de partage (#hash)
  <br>
  <a href="https://github.com/lesplint/Recoil-Rematch/blob/main/README.md" 
     target="_blank" 
     style="color:#9aa4af;text-decoration:none;">
     üìò Voir le guide complet (README)
  </a>
</footer>
  
  <script>
    (function(){
      var TEAM_BLUE="blue", TEAM_RED="red";
      var modeSelect=document.getElementById("mode"), field=document.getElementById("field"), resetBtn=document.getElementById("reset");
      var blueCountEl=document.getElementById("blueCount"), redCountEl=document.getElementById("redCount");
      var exportBtn=document.getElementById("exportBtn"), importBtn=document.getElementById("importBtn"), importFile=document.getElementById("importFile");
      var copyShare=document.getElementById("copyShare");
      var ctx=document.getElementById("ctx"), ctxRename=document.getElementById("ctxRename"), ctxDuplicate=document.getElementById("ctxDuplicate"), ctxDelete=document.getElementById("ctxDelete");

      var players=[], ball=null, dragId=null, dragBall=false;
      var clickTimes = {}; // dblclick fallback
      var pressTimers = {}; // long-press -> open context menu (players only)
      var dragStart = null; var dragThresholdPx = 4;
      var ctxTargetId = null;

      document.addEventListener("contextmenu", function(e){ e.preventDefault(); });

      function initialLayout(mode){
        var n = mode==="5v5" ? 5 : 3;
        var blue = Array.from({length:n}, function(_,i){ return {id:"B"+(i+1), label:"B"+(i+1), team:TEAM_BLUE, x:20, y:((i+1)*100)/(n+1)}; });
        var red  = Array.from({length:n}, function(_,i){ return {id:"R"+(i+1), label:"R"+(i+1), team:TEAM_RED,  x:80, y:((i+1)*100)/(n+1)}; });
        return blue.concat(red);
      }
      function initialBall(){ return { id:"BALL", x:50, y:50 }; }
      function clamp(v,min,max){ return Math.min(Math.max(v,min),max); }

      function base64urlEncode(str){
        try{ return btoa(unescape(encodeURIComponent(str))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,""); }catch(e){ return ""; }
      }
      function base64urlDecode(str){
        try{
          var pad = str.length%4===2 ? "==" : (str.length%4===3 ? "=" : "");
          var s = str.replace(/-/g,"+").replace(/_/g,"/")+pad;
          return decodeURIComponent(escape(atob(s)));
        }catch(e){ return ""; }
      }
      function makeShareLink(){
        var state = JSON.stringify({mode:modeSelect.value, players:players, ball:ball});
        var enc = base64urlEncode(state);
        return location.origin + location.pathname + "#state=" + enc;
      }
      function decodeHashState(){
        if(location.hash && location.hash.indexOf("#state=")===0){
          var enc = location.hash.substring(7);
          var json = base64urlDecode(enc);
          try{ return JSON.parse(json); }catch(e){ return null; }
        }
        return null;
      }

      function save(){
        try{
          localStorage.setItem("rematch_mode", modeSelect.value);
          localStorage.setItem("rematch_players", JSON.stringify(players));
          localStorage.setItem("rematch_ball", JSON.stringify(ball));
          history.replaceState(null,"", makeShareLink());
        }catch(e){}
        renderCounts();
      }
      function load(){
        try{
          var fromHash = decodeHashState();
          if(fromHash){
            modeSelect.value = fromHash.mode || "5v5";
            players = fromHash.players || initialLayout(modeSelect.value);
            ball = fromHash.ball || initialBall();
            return;
          }
          var m=localStorage.getItem("rematch_mode"); if(m) modeSelect.value=m;
          var p=localStorage.getItem("rematch_players"); if(p){ players=JSON.parse(p); } else { players = initialLayout(modeSelect.value); }
          var b=localStorage.getItem("rematch_ball"); if(b){ ball=JSON.parse(b); } else { ball=initialBall(); }
        }catch(e){
          players = initialLayout(modeSelect.value); ball = initialBall();
        }
      }

      function renderCounts(){
        var b=players.filter(function(p){return p.team===TEAM_BLUE}).length;
        var r=players.filter(function(p){return p.team===TEAM_RED}).length;
        blueCountEl.textContent=b; redCountEl.textContent=r;
      }
      function clearDom(){
        var nodes=field.querySelectorAll(".player, .ball"); for(var i=0;i<nodes.length;i++) nodes[i].remove();
      }

      function promptRename(p, el){
        var name = prompt("Nom/num√©ro du joueur :", p.label || p.id);
        if(name && name.trim()){
          for(var i=0;i<players.length;i++) if(players[i].id===p.id) players[i].label=name.trim();
          el.textContent=name.trim();
          save();
        }
      }
      function nextId(team){
        var prefix = team===TEAM_BLUE ? "B" : "R";
        var max = 0;
        for(var i=0;i<players.length;i++){
          if(players[i].team===team){
            var num = parseInt((players[i].id||"").replace(/[^\d]/g,""),10);
            if(!isNaN(num)) max = Math.max(max, num);
          }
        }
        return prefix + (max+1);
      }
      function teamLimit(team){
        var limit = (modeSelect.value==="5v5") ? 5 : 3;
        var count = players.filter(function(p){return p.team===team}).length;
        return {limit:limit, count:count, ok: count < limit};
      }
      function duplicatePlayer(p){
        var lim = teamLimit(p.team);
        if(!lim.ok){ alert("√âquipe d√©j√† compl√®te ("+lim.limit+"). Supprime un joueur avant de dupliquer."); return; }
        var id = nextId(p.team);
        var np = { id:id, label:id, team:p.team, x:clamp(p.x+3,3,97), y:clamp(p.y+3,3,97) };
        players.push(np);
        renderAll();
      }
      function deletePlayer(p){
        players = players.filter(function(pp){ return pp.id !== p.id; });
        renderAll();
      }

      function openMenuFor(p, el, x, y){
        ctxTargetId = p.id;
        ctx.style.left = Math.min(x, window.innerWidth - 200) + "px";
        ctx.style.top  = Math.min(y, window.innerHeight - 160) + "px";
        ctx.style.display = "block";
        ctx.setAttribute("aria-hidden","false");
      }
      function closeMenu(){
        ctxTargetId = null;
        ctx.style.display = "none";
        ctx.setAttribute("aria-hidden","true");
      }
      document.addEventListener("pointerdown", function(e){
        if(!ctx.contains(e.target)) closeMenu();
      });
      window.addEventListener("resize", closeMenu);
      window.addEventListener("scroll", closeMenu, true);

      ctxRename.addEventListener("click", function(){
        if(!ctxTargetId) return;
        var el = field.querySelector('.player[data-id="'+ctxTargetId+'"]');
        var p = players.find(function(pp){return pp.id===ctxTargetId});
        if(p && el) promptRename(p, el);
        closeMenu();
      });
      ctxDuplicate.addEventListener("click", function(){
        if(!ctxTargetId) return;
        var p = players.find(function(pp){return pp.id===ctxTargetId});
        if(p) duplicatePlayer(p);
        closeMenu();
      });
      ctxDelete.addEventListener("click", function(){
        if(!ctxTargetId) return;
        var p = players.find(function(pp){return pp.id===ctxTargetId});
        if(p) deletePlayer(p);
        closeMenu();
      });

      function createPlayerEl(p){
        var el=document.createElement("div");
        el.className="player " + (p.team===TEAM_BLUE?"blue":"red");
        el.textContent=p.label||p.id;
        el.style.left=p.x+"%"; el.style.top=p.y+"%";
        el.setAttribute("data-id", p.id); el.setAttribute("role","button");
        el.setAttribute("aria-label","Joueur "+(p.label||p.id));

        var localDragId = null, dragStart = null;
        function onPointerDown(e){
          e.preventDefault();
          localDragId = null;
          dragStart = { x: (e.clientX||0), y: (e.clientY||0) };

          clearTimeout(pressTimers[p.id]);
          pressTimers[p.id] = setTimeout(function(){
            openMenuFor(p, el, (e.clientX||0), (e.clientY||0));
          }, 600);

          el.addEventListener("pointermove", onPointerMove);
          el.addEventListener("pointerup", onPointerUp);
          el.addEventListener("pointercancel", onPointerUp);
        }
        function onPointerMove(e){
          var dx = Math.abs((e.clientX||0) - dragStart.x);
          var dy = Math.abs((e.clientY||0) - dragStart.y);
          if (dx>dragThresholdPx || dy>dragThresholdPx){
            clearTimeout(pressTimers[p.id]);
            if (!localDragId) localDragId = p.id;
          }
          if (localDragId){
            var rect=field.getBoundingClientRect();
            var cx=(e.clientX!==undefined)?e.clientX:0;
            var cy=(e.clientY!==undefined)?e.clientY:0;
            var xPct=((cx-rect.left)/rect.width)*100, yPct=((cy-rect.top)/rect.height)*100;
            players=players.map(function(pp){ return pp.id===localDragId?{id:pp.id,label:pp.label,team:pp.team,x:clamp(xPct,3,97),y:clamp(yPct,3,97)}:pp; });
            el.style.left=clamp(xPct,3,97)+"%"; el.style.top=clamp(yPct,3,97)+"%";
          }
        }
        function onPointerUp(e){
          el.removeEventListener("pointermove", onPointerMove);
          el.removeEventListener("pointerup", onPointerUp);
          el.removeEventListener("pointercancel", onPointerUp);
          clearTimeout(pressTimers[p.id]);

          if (!localDragId){
            var now = Date.now();
            var last = clickTimes[p.id] || 0;
            clickTimes[p.id] = now;
            if (now - last < 300){
              promptRename(p, el);
              clickTimes[p.id] = 0;
            }
          } else {
            save();
          }
          localDragId = null;
        }

        el.addEventListener("contextmenu", function(ev){
          ev.preventDefault();
          openMenuFor(p, el, ev.clientX, ev.clientY);
        });
        el.addEventListener("dblclick", function(){ promptRename(p, el); });
        el.addEventListener("pointerdown", onPointerDown);
        return el;
      }

      function createBallEl(){
        var el=document.createElement("div");
        el.className="ball";
        el.textContent="‚öΩÔ∏è";
        el.style.left=ball.x+"%"; el.style.top=ball.y+"%";
        el.setAttribute("role","button"); el.setAttribute("aria-label","Balle");

        var dragging=false, start=null;
        el.addEventListener("pointerdown", function(e){
          e.preventDefault();
          dragging=false;
          start = { x:(e.clientX||0), y:(e.clientY||0) };
          function move(ev){
            var dx=Math.abs((ev.clientX||0)-start.x), dy=Math.abs((ev.clientY||0)-start.y);
            if (dx>dragThresholdPx || dy>dragThresholdPx){ dragging=true; }
            var rect=field.getBoundingClientRect();
            var cx=(ev.clientX!==undefined)?ev.clientX:0;
            var cy=(ev.clientY!==undefined)?ev.clientY:0;
            var xPct=((cx-rect.left)/rect.width)*100, yPct=((cy-rect.top)/rect.height)*100;
            ball.x=clamp(xPct,3,97); ball.y=clamp(yPct,3,97);
            el.style.left=ball.x+"%"; el.style.top=ball.y+"%";
          }
          function up(){
            field.removeEventListener("pointermove", move);
            window.removeEventListener("pointerup", up);
            save();
          }
          field.addEventListener("pointermove", move);
          window.addEventListener("pointerup", up);
        });
        return el;
      }

      function renderAll(){
        clearDom();
        // players
        for(var i=0;i<players.length;i++) field.appendChild(createPlayerEl(players[i]));
        // ball
        if(!ball) ball = initialBall();
        field.appendChild(createBallEl());
        renderCounts(); save();
      }

      function resetPositions(){
        players = initialLayout(modeSelect.value);
        ball = initialBall();
        renderAll();
      }

      function download(filename,text){
        var a=document.createElement("a");
        a.setAttribute("href","data:application/json;charset=utf-8,"+encodeURIComponent(text));
        a.setAttribute("download",filename); a.style.display="none"; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      }
      function exportJSON(){
        var data=JSON.stringify({mode:modeSelect.value, players:players, ball:ball}, null, 2);
        download("composition-rematch.json", data);
      }
      function importJSON(file){
        var reader=new FileReader();
        reader.onload=function(ev){
          try{
            var obj=JSON.parse(ev.target.result);
            if(obj && obj.players && obj.players.length){
              modeSelect.value=obj.mode||modeSelect.value;
              players=obj.players;
              ball=obj.ball || initialBall();
              renderAll();
              alert("Composition import√©e ‚úîÔ∏è");
            }else{ alert("Fichier invalide."); }
          }catch(e){ alert("Erreur de lecture du JSON."); }
        };
        reader.readAsText(file);
      }
      function copyToClipboard(text){
        if(navigator.clipboard && navigator.clipboard.writeText){ navigator.clipboard.writeText(text).then(function(){ alert("Lien copi√© ‚úîÔ∏è"); }); }
        else{ var ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta); ta.select(); try{ document.execCommand("copy"); alert("Lien copi√© ‚úîÔ∏è"); }catch(e){} document.body.removeChild(ta); }
      }

      field.addEventListener("pointerleave", function(){ dragId=null; });
      window.addEventListener("pointerup", function(){ dragId=null; });

      modeSelect.addEventListener("change", function(){
        var need = this.value==="5v5" ? 10 : 6;
        var blue = players.filter(function(p){return p.team===TEAM_BLUE}).length;
        var red  = players.filter(function(p){return p.team===TEAM_RED}).length;
        var limit = (this.value==="5v5")?5:3;
        if (blue>limit || red>limit || players.length!==need){
          players = initialLayout(this.value);
        }
        renderAll();
      });
      resetBtn.addEventListener("click", resetPositions);
      exportBtn.addEventListener("click", exportJSON);
      importBtn.addEventListener("click", function(){ importFile.click(); });
      importFile.addEventListener("change", function(ev){ if(ev.target.files && ev.target.files[0]) importJSON(ev.target.files[0]); });
      copyShare.addEventListener("click", function(){ copyToClipboard(makeShareLink()); });

      // Init
      load(); renderAll();
    })();
  </script>
</body>
</html>
